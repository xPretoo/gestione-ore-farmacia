<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pianificazione Settimanale Multi-Sede</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            @apply w-full p-1 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#93ad90] text-center;
        }
        .input-group {
            @apply flex flex-col space-y-1;
        }
        .employee-input {
            @apply p-2 border border-gray-300 rounded-lg;
        }
        .time-slot-input {
            @apply p-2 border border-gray-300 rounded-lg;
        }
        .modal {
            @apply fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center;
        }
        .modal-content {
            @apply relative p-6 bg-white rounded-3xl shadow-xl max-w-lg w-full mx-4;
        }
        .error-input {
            @apply border-red-500 ring-2 ring-red-500;
        }
        .remove-time-slot-btn {
            @apply bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center w-8 h-8;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background-color: #f87171;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-150%);
            transition: transform 0.4s ease-in-out;
            z-index: 100;
        }
        .message-box.visible {
            transform: translateY(0);
        }
        .hours-cell.completed {
            background-color: #d1fae5; /* green-100 */
        }
        .hours-cell.incomplete {
            background-color: #fee2e2; /* red-100 */
        }
        .hours-cell.completed, .hours-cell.incomplete {
            font-weight: 700;
        }
        .schedule-table-cell.duplicate-id {
            background-color: #f8e1e1; /* light red */
            border: 2px solid #ef4444; /* red-500 */
        }
        .bg-custom-main {
            background-color: #93ad90;
        }
        .text-custom-main {
            color: #93ad90;
        }
        .ring-custom-main {
            --tw-ring-color: #93ad90;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .main-content-to-print {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white p-6 rounded-3xl shadow-lg border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-custom-main mb-6">Pianificazione Settimanale</h1>

        <!-- Selettore Sede e Gestione -->
        <div class="mb-4 flex items-center justify-center space-x-2">
            <label for="location-select" class="font-semibold text-gray-700">Sede:</label>
            <select id="location-select" class="p-2 border border-gray-300 rounded-lg cursor-pointer focus:outline-none focus:ring-2 ring-custom-main">
                <!-- Opzioni sede da JavaScript -->
            </select>
            <button id="manage-locations-btn" class="bg-custom-main text-white p-2 rounded-lg font-semibold hover:bg-opacity-80 transition-colors">
                Gestisci Sedi
            </button>
        </div>

        <!-- Selettore Data -->
        <div class="flex items-center justify-between mb-6">
            <button id="prev-week" class="bg-gray-200 text-gray-800 p-2 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <div id="week-display" class="flex flex-col items-center text-lg font-medium text-gray-700">
                <span id="week-dates" class="text-center"></span>
                <span id="week-info" class="text-sm text-gray-500"></span>
            </div>
            <button id="next-week" class="bg-gray-200 text-gray-800 p-2 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
        
        <!-- Pulsanti di Stampa ed Esportazione -->
        <div class="flex flex-col sm:flex-row justify-center gap-4 mb-8 no-print">
            <button id="printBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Stampa Orario Settimanale
            </button>
            <button id="exportBtn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                Esporta Orario Multi-settimanale
            </button>
        </div>

        <!-- Tabella Settimanale -->
        <div id="schedule-container" class="overflow-x-auto mb-6 rounded-lg border border-gray-200 shadow-sm main-content-to-print">
            <table class="w-full text-center table-auto border-collapse">
                <thead class="bg-custom-main text-white">
                    <tr>
                        <th class="p-3 border-r border-custom-main">Fascia Oraria</th>
                        <th class="p-3">Lunedì</th>
                        <th class="p-3">Martedì</th>
                        <th class="p-3">Mercoledì</th>
                        <th class="p-3">Giovedì</th>
                        <th class="p-3">Venerdì</th>
                        <th class="p-3">Sabato</th>
                        <th class="p-3">Domenica</th>
                    </tr>
                </thead>
                <tbody id="schedule-body" class="bg-white text-gray-800">
                    <!-- Le righe verranno generate da JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Tabella Dipendenti -->
        <div class="mb-6 no-print">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Dipendenti</h2>
            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                <table class="w-full text-center table-auto border-collapse">
                    <thead class="bg-gray-700 text-white">
                        <tr>
                            <th class="p-3">Dipendente</th>
                            <th class="p-3">ID</th>
                            <th class="p-3">Ore Settimanali</th>
                            <th class="p-3">Ore Assegnate</th>
                            <th class="p-3">Ore Residue</th>
                        </tr>
                    </thead>
                    <tbody id="employees-body" class="bg-white text-gray-800">
                        <!-- Le righe verranno generate da JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sezione Dati Utente -->
        <div class="text-center text-gray-500 text-sm mt-4 no-print">
            <p>ID utente: <span id="user-id"></span></p>
        </div>
        
        <!-- Pulsanti di configurazione separati -->
        <div class="mt-8 pt-4 border-t border-gray-300 grid grid-cols-1 sm:grid-cols-2 gap-4 no-print">
            <button id="edit-employees-btn" class="bg-custom-main text-white p-4 rounded-lg font-semibold hover:bg-opacity-80 transition-colors">
                Gestisci Dipendenti
            </button>
            <button id="edit-time-slots-btn" class="bg-custom-main text-white p-4 rounded-lg font-semibold hover:bg-opacity-80 transition-colors">
                Gestisci Fasce Orarie
            </button>
        </div>
    </div>

    <!-- Modali di configurazione -->
    <div id="employees-modal" class="modal hidden no-print">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Configurazione Dipendenti</h3>
            <div id="employees-config" class="mb-4"></div>
            <div id="employee-error" class="text-red-500 text-sm mb-4"></div>
            <div class="flex justify-end space-x-2">
                <button id="save-employees-btn" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">Salva</button>
                <button id="cancel-employees-btn" class="bg-gray-400 text-white p-2 rounded-lg hover:bg-gray-500 transition-colors">Annulla</button>
            </div>
        </div>
    </div>

    <div id="time-slots-modal" class="modal hidden no-print">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Configurazione Fasce Orarie</h3>
            <div id="time-slots-config" class="mb-4"></div>
            <div class="flex justify-end space-x-2">
                <button id="save-time-slots-btn" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">Salva</button>
                <button id="cancel-time-slots-btn" class="bg-gray-400 text-white p-2 rounded-lg hover:bg-gray-500 transition-colors">Annulla</button>
            </div>
        </div>
    </div>
    
    <!-- Modale Gestione Sedi -->
    <div id="locations-modal" class="modal hidden no-print">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Gestione Sedi</h3>
            <div id="locations-list" class="mb-4"></div>
            <div class="flex justify-end space-x-2">
                <button id="add-location-btn" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">Aggiungi Sede</button>
                <button id="close-locations-modal" class="bg-gray-400 text-white p-2 rounded-lg hover:bg-gray-500 transition-colors">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per l'esportazione multi-settimanale -->
    <div id="export-modal" class="modal hidden no-print">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Seleziona le date da esportare</h3>
            <div class="mb-4">
                <label for="startDateInput" class="block text-gray-700 mb-2">Data di inizio:</label>
                <input type="date" id="startDateInput" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <label for="endDateInput" class="block text-gray-700 mb-2">Data di fine:</label>
                <input type="date" id="endDateInput" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end gap-2">
                <button id="cancelExportBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition">
                    Annulla
                </button>
                <button id="confirmExportBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                    Conferma
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box for Alerts -->
    <div id="message-box" class="message-box"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, orderBy, limit, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "dummy-key",
            authDomain: "dummy.firebaseapp.com",
            projectId: "dummy-project"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let locations = [];
        let currentLocationId = null;
        let employees = [];
        let scheduleHours = [];
        let employeeIds = new Set();
        
        let currentWeekStart = new Date();
        let currentSchedule = {};
        
        // Funzione per mostrare un messaggio di avviso personalizzato
        function showMessage(message, duration = 3000) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.classList.add('visible');
            setTimeout(() => {
                msgBox.classList.remove('visible');
            }, duration);
        }
        
        // --- AUTHENTICATION & INITIALIZATION ---
        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                document.getElementById('user-id').textContent = userId;
                
                await loadLocations();
            } catch (error) {
                console.error("Errore di autenticazione Firebase:", error);
            }
        }

        async function loadLocations() {
            if (!userId) return;
            const locationsCol = collection(db, `artifacts/${appId}/users/${userId}/locations`);
            
            // Inizializza le sedi se la collezione è vuota
            const initialSnapshot = await getDocs(locationsCol);
            if (initialSnapshot.empty) {
                const initialLocations = ["Savio", "Lido di Savio", "Lido di Classe", "Castiglione"];
                for (const name of initialLocations) {
                    await addLocation(name);
                }
            }
            
            onSnapshot(locationsCol, (snapshot) => {
                locations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Imposta la sede predefinita su Savio se presente
                const savioLocation = locations.find(loc => loc.name === 'Savio');
                if (savioLocation && !currentLocationId) {
                    currentLocationId = savioLocation.id;
                } else if (!currentLocationId && locations.length > 0) {
                    currentLocationId = locations[0].id;
                }
                
                renderLocationSelect();
                loadConfigAndSchedule();
            }, (error) => {
                console.error("Errore nel recupero delle sedi:", error);
            });
        }
        
        async function addLocation(name) {
            if (!userId) return;
            const locationsCol = collection(db, `artifacts/${appId}/users/${userId}/locations`);
            await setDoc(doc(locationsCol), { name });
        }

        async function loadConfigAndSchedule() {
            if (!userId || !currentLocationId) return;
            
            // Carica la configurazione specifica della sede
            const configsCol = collection(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/configs`);
            const configQuery = query(configsCol, where('startDate', '<=', formatDate(currentWeekStart)), orderBy('startDate', 'desc'), limit(1));
            
            const querySnapshot = await getDocs(configQuery);

            if (!querySnapshot.empty) {
                const configData = querySnapshot.docs[0].data();
                employees = JSON.parse(configData.employees);
                scheduleHours = JSON.parse(configData.scheduleHours);
            } else {
                // Configurazione di default
                employees = [
                    { name: 'Linda', id: 'L', weeklyHours: 40, assignedHours: 0, remainingHours: 40 },
                    { name: 'Giorgia', id: 'G', weeklyHours: 32, assignedHours: 0, remainingHours: 32 },
                    { name: 'Chiara B', id: 'C', weeklyHours: 32, assignedHours: 0, remainingHours: 32 },
                    { name: 'Chiara M', id: 'K', weeklyHours: 40, assignedHours: 0, remainingHours: 40 },
                    { name: 'Melissa', id: 'M', weeklyHours: 24, assignedHours: 0, remainingHours: 24 }
                ];
                scheduleHours = [{ start: '08:30', end: '12:30' }, { start: '15:30', end: '19:30' }];
            }
            employeeIds = new Set(employees.map(e => e.id.toUpperCase()));
            renderEmployeeConfig();
            renderTimeSlotsConfig();
            loadSchedule();
        }
        
        async function saveEmployeesConfig() {
            if (!userId || !currentLocationId) return;
            const configData = [];
            let isValid = true;
            let ids = new Set();
            const employeeRows = document.querySelectorAll('#employees-config .employee-entry');
            const errorElement = document.getElementById('employee-error');
            errorElement.textContent = ''; // Resetta il messaggio di errore

            employeeRows.forEach(row => {
                const idInput = row.querySelector('.employee-id');
                const nameInput = row.querySelector('.employee-name');
                const hoursInput = row.querySelector('.employee-hours');
                
                const id = idInput.value.toUpperCase().trim();
                const name = nameInput.value.trim();
                const weeklyHours = parseInt(hoursInput.value) || 0;

                idInput.classList.remove('error-input');
                nameInput.classList.remove('error-input');
                hoursInput.classList.remove('error-input');
                
                if (!id || !name || !weeklyHours) {
                    isValid = false;
                    errorElement.textContent = 'Errore: Tutti i campi (Nome, ID, Ore Sett.) sono obbligatori.';
                    if (!id) idInput.classList.add('error-input');
                    if (!name) nameInput.classList.add('error-input');
                    if (!weeklyHours) hoursInput.classList.add('error-input');
                    return;
                }

                if (ids.has(id)) {
                    isValid = false;
                    errorElement.textContent = `Errore: l'ID "${id}" è duplicato. Ogni dipendente deve avere un ID unico.`;
                    idInput.classList.add('error-input');
                }
                ids.add(id);
                configData.push({ name, id, weeklyHours });
            });

            if (!isValid) {
                return;
            }

            const dateKey = formatDate(currentWeekStart);
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/configs`, dateKey);

            try {
                await setDoc(docRef, {
                    startDate: dateKey,
                    employees: JSON.stringify(configData),
                    scheduleHours: JSON.stringify(scheduleHours),
                    timestamp: Date.now()
                });
                showMessage('Configurazione dipendenti salvata!');
                document.getElementById('employees-modal').classList.add('hidden');
                loadConfigAndSchedule();
            } catch (error) {
                console.error("Errore nel salvataggio della configurazione dei dipendenti:", error);
                showMessage("Errore nel salvataggio. Controlla la console.");
            }
        }

        async function saveTimeSlotsConfig() {
            if (!userId || !currentLocationId) return;
            const timeSlotsData = [];
            document.querySelectorAll('#time-slots-config .time-slot-entry').forEach(row => {
                timeSlotsData.push({
                    start: row.querySelector('.time-slot-start').value,
                    end: row.querySelector('.time-slot-end').value
                });
            });
            
            const dateKey = formatDate(currentWeekStart);
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/configs`, dateKey);

            try {
                await setDoc(docRef, {
                    startDate: dateKey,
                    employees: JSON.stringify(employees),
                    scheduleHours: JSON.stringify(timeSlotsData),
                    timestamp: Date.now()
                });
                showMessage('Configurazione fasce orarie salvata!');
                document.getElementById('time-slots-modal').classList.add('hidden');
                loadConfigAndSchedule();
            } catch (error) {
                console.error("Errore nel salvataggio della configurazione delle fasce orarie:", error);
                showMessage("Errore nel salvataggio. Controlla la console.");
            }
        }

        async function saveSchedule() {
            if (!userId || !currentLocationId) return;
            const dateKey = formatDate(currentWeekStart);
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/schedules`, dateKey);
            
            // Check for any remaining errors before saving
            const inputs = document.querySelectorAll('input[data-slot]');
            for(const input of inputs) {
                if (input.classList.contains('error-input')) {
                    showMessage("Correggi gli errori prima di salvare.");
                    return;
                }
            }

            try {
                await setDoc(docRef, {
                    schedule: JSON.stringify(currentSchedule),
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error("Errore nel salvataggio della pianificazione:", error);
                showMessage("Errore nel salvataggio. Controlla la console.");
            }
        }

        async function loadSchedule() {
            if (!userId || !currentLocationId) return;
            const dateKey = formatDate(currentWeekStart);
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/schedules`, dateKey);
            
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    try {
                        currentSchedule = JSON.parse(doc.data().schedule);
                    } catch (e) {
                        console.error("Errore nell'analisi dei dati del documento:", e);
                        currentSchedule = {};
                    }
                } else {
                    currentSchedule = {};
                }
                updateTotalHours();
                render();
            }, (error) => {
                console.error("Errore nel recupero del documento:", error);
            });
        }
        
        function calculateDuration(start, end) {
            const [startHour, startMinute] = start.split(':').map(Number);
            const [endHour, endMinute] = end.split(':').map(Number);
            const startTime = startHour * 60 + startMinute;
            const endTime = endHour * 60 + endMinute;
            return (endTime - startTime) / 60;
        }

        async function updateTotalHours() {
            const assignedHoursMap = {};
            employees.forEach(emp => {
                assignedHoursMap[emp.id.toUpperCase().trim()] = 0;
            });
            
            const weekStartDate = formatDate(currentWeekStart);

            for (const loc of locations) {
                const scheduleDocRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${loc.id}/schedules`, weekStartDate);
                const scheduleDoc = await getDoc(scheduleDocRef);
                
                if (scheduleDoc.exists()) {
                    try {
                        const scheduleData = JSON.parse(scheduleDoc.data().schedule);
                        for (const key in scheduleData) {
                            if (scheduleData.hasOwnProperty(key)) {
                                const parts = key.split('-');
                                const start = parts[0];
                                const end = parts[1];
                                const duration = calculateDuration(start, end);
                                const assignedEmployees = scheduleData[key];
                                assignedEmployees.forEach(employeeId => {
                                    const empId = employeeId.toUpperCase().trim();
                                    const emp = employees.find(e => e.id.toUpperCase().trim() === empId);
                                    if (emp) {
                                        assignedHoursMap[empId] = (assignedHoursMap[empId] || 0) + duration;
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        console.error("Errore nell'analisi della pianificazione per la sede:", loc.name, e);
                    }
                }
            }

            employees.forEach(emp => {
                const empId = emp.id.toUpperCase().trim();
                emp.assignedHours = assignedHoursMap[empId] || 0;
                emp.remainingHours = emp.weeklyHours - emp.assignedHours;
            });
            
            renderEmployeesTable();
        }

        // --- RENDERING & UI UPDATES ---
        function render() {
            renderScheduleTable();
            updateWeekDisplay();
        }
        
        function renderLocationSelect() {
            const select = document.getElementById('location-select');
            select.innerHTML = '';
            locations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.textContent = loc.name;
                select.appendChild(option);
            });
            select.value = currentLocationId;
        }

        function renderScheduleTable() {
            const tableBody = document.getElementById('schedule-body');
            tableBody.innerHTML = '';
            
            scheduleHours.forEach((hour, hourIndex) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                
                const hourCell = document.createElement('td');
                hourCell.className = 'p-3 text-sm font-medium text-gray-700 whitespace-nowrap text-center';
                hourCell.innerHTML = `<div class="flex flex-col items-center"><span>${hour.start}</span><span>${hour.end}</span></div>`;
                row.appendChild(hourCell);
                
                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('td');
                    cell.className = 'p-2 relative';
                    
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';

                    const scheduleKey = `${hour.start}-${hour.end}-${day}`;
                    if (!currentSchedule[scheduleKey]) {
                        currentSchedule[scheduleKey] = ['', '', '', ''];
                    }

                    for (let i = 0; i < 4; i++) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentSchedule[scheduleKey][i] || '';
                        input.dataset.slot = scheduleKey;
                        input.dataset.index = i;
                        input.classList.add('w-16');
                        
                        input.addEventListener('input', (e) => {
                            const slot = e.target.dataset.slot;
                            const index = e.target.dataset.index;
                            
                            currentSchedule[slot][index] = e.target.value.toUpperCase();
                            saveSchedule();
                            updateTotalHours();
                            updateCellHighlights();
                        });
                        
                        inputGroup.appendChild(input);
                    }
                    
                    cell.appendChild(inputGroup);
                    row.appendChild(cell);
                }
                tableBody.appendChild(row);
            });
            updateCellHighlights();
        }
        
        function updateCellHighlights() {
            const allInputs = document.querySelectorAll('input[data-slot]');
            
            // Clear all error highlights first
            allInputs.forEach(input => {
                input.classList.remove('error-input');
            });
            
            const occupiedIDsBySlot = {};
            let hasError = false;

            // Check for invalid IDs and collect IDs per slot
            allInputs.forEach(input => {
                const value = input.value.toUpperCase().trim();
                const slotKey = input.dataset.slot;

                if (value) {
                    // Check for invalid ID
                    if (!employeeIds.has(value)) {
                        input.classList.add('error-input');
                        hasError = true;
                        showMessage(`L'ID "${value}" non esiste!`);
                    }

                    // Collect IDs for the current slot
                    if (!occupiedIDsBySlot[slotKey]) {
                        occupiedIDsBySlot[slotKey] = [];
                    }
                    occupiedIDsBySlot[slotKey].push({ value: value, input: input });
                }
            });

            // Check for duplicate IDs within each slot
            for (const slotKey in occupiedIDsBySlot) {
                const idsInSlot = occupiedIDsBySlot[slotKey].map(item => item.value);
                const uniqueIds = new Set(idsInSlot);

                if (uniqueIds.size < idsInSlot.length) {
                    // Duplicates found in this slot
                    const counts = {};
                    idsInSlot.forEach(id => {
                        counts[id] = (counts[id] || 0) + 1;
                    });
                    occupiedIDsBySlot[slotKey].forEach(item => {
                        if (counts[item.value] > 1) {
                            item.input.classList.add('error-input');
                            hasError = true;
                            showMessage(`L'ID "${item.value}" è duplicato nella stessa fascia oraria!`);
                        }
                    });
                }
            }
        }


        function renderEmployeesTable() {
            const tableBody = document.getElementById('employees-body');
            tableBody.innerHTML = '';

            employees.forEach(emp => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                
                const nameCell = document.createElement('td');
                nameCell.className = 'p-3 text-sm font-medium text-center';
                nameCell.textContent = emp.name;
                row.appendChild(nameCell);
                
                const idCell = document.createElement('td');
                idCell.className = 'p-3 text-sm text-center';
                idCell.textContent = emp.id;
                row.appendChild(idCell);
                
                const weeklyHoursCell = document.createElement('td');
                weeklyHoursCell.className = 'p-3 text-sm text-center';
                weeklyHoursCell.textContent = emp.weeklyHours;
                row.appendChild(weeklyHoursCell);

                const assignedHoursCell = document.createElement('td');
                assignedHoursCell.className = 'p-3 text-sm hours-cell text-center';
                assignedHoursCell.textContent = emp.assignedHours;
                
                if (emp.assignedHours === emp.weeklyHours) {
                    assignedHoursCell.classList.add('completed');
                } else {
                    assignedHoursCell.classList.remove('completed');
                }
                
                row.appendChild(assignedHoursCell);

                const remainingHoursCell = document.createElement('td');
                remainingHoursCell.className = 'p-3 text-sm hours-cell text-center';
                remainingHoursCell.textContent = emp.remainingHours;

                if (emp.remainingHours > 0) {
                    remainingHoursCell.classList.add('incomplete');
                } else {
                    remainingHoursCell.classList.remove('incomplete');
                }
                
                row.appendChild(remainingHoursCell);
                
                tableBody.appendChild(row);
            });
        }

        function renderEmployeeConfig() {
            const configContainer = document.getElementById('employees-config');
            configContainer.innerHTML = `
                <div class="flex items-center space-x-2 mb-2 font-semibold text-sm text-center">
                    <span class="w-1/3">Nome</span>
                    <span class="w-1/6">ID</span>
                    <span class="w-1/6">Ore Sett.</span>
                    <span class="w-1/6"></span>
                </div>
            `;
            employees.forEach((emp) => {
                const row = document.createElement('div');
                row.className = 'employee-entry flex items-center space-x-2 mb-2';
                row.innerHTML = `
                    <input type="text" class="w-1/3 employee-input employee-name" value="${emp.name}" placeholder="Nome">
                    <input type="text" class="w-1/6 employee-input employee-id text-center" value="${emp.id}" placeholder="ID">
                    <input type="number" class="w-1/6 employee-input employee-hours" value="${emp.weeklyHours}" placeholder="Ore">
                    <button class="w-1/6 bg-red-500 text-white p-2 rounded-lg remove-employee-btn">Rimuovi</button>
                `;
                configContainer.appendChild(row);
            });
            const addBtn = document.createElement('button');
            addBtn.textContent = 'Aggiungi Dipendente';
            addBtn.className = 'bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors mt-4';
            addBtn.onclick = addEmployeeField;
            configContainer.appendChild(addBtn);

            document.querySelectorAll('.remove-employee-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.employee-entry').remove();
                });
            });
        }
        
        function getHourOptions() {
            const options = [];
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hour = String(h).padStart(2, '0');
                    const minute = String(m).padStart(2, '0');
                    options.push(`${hour}:${minute}`);
                }
            }
            return options;
        }

        function renderTimeSlotsConfig() {
            const configContainer = document.getElementById('time-slots-config');
            configContainer.innerHTML = `
                <div class="flex items-center space-x-2 mb-2 font-semibold text-sm">
                    <span class="w-1/3">Inizio</span>
                    <span class="w-1/3">Fine</span>
                    <span class="w-1/6"></span>
                </div>
            `;
            const hourOptions = getHourOptions();

            scheduleHours.forEach((slot) => {
                const row = document.createElement('div');
                row.className = 'time-slot-entry flex items-center space-x-2 mb-2';
                
                const startSelect = document.createElement('select');
                startSelect.className = 'w-1/3 time-slot-input time-slot-start';
                hourOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    startSelect.appendChild(opt);
                });
                startSelect.value = slot.start;

                const endSelect = document.createElement('select');
                endSelect.className = 'w-1/3 time-slot-input time-slot-end';
                hourOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    endSelect.appendChild(opt);
                });
                endSelect.value = slot.end;

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = `&times;`;
                removeBtn.className = 'remove-time-slot-btn';

                row.appendChild(startSelect);
                row.appendChild(endSelect);
                row.appendChild(removeBtn);
                configContainer.appendChild(row);
            });
            const addBtn = document.createElement('button');
            addBtn.textContent = 'Aggiungi Fascia Oraria';
            addBtn.className = 'bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors mt-4';
            addBtn.onclick = addTimeSlotField;
            configContainer.appendChild(addBtn);

            document.querySelectorAll('.remove-time-slot-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.time-slot-entry').remove();
                });
            });
        }

        function renderLocationsModal() {
            const locationsList = document.getElementById('locations-list');
            locationsList.innerHTML = '';
            
            locations.forEach(loc => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 border-b border-gray-200';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = loc.name;
                input.className = 'w-1/2 p-1 border border-transparent rounded-lg focus:outline-none focus:ring-2 ring-custom-main';
                input.addEventListener('change', async (e) => {
                    await setDoc(doc(db, `artifacts/${appId}/users/${userId}/locations`, loc.id), { name: e.target.value }, { merge: true });
                });
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Rimuovi';
                removeBtn.className = 'bg-red-500 text-white p-1 rounded-lg text-xs hover:bg-red-600 transition-colors';
                removeBtn.addEventListener('click', async () => {
                     // Check if there is only one location left, prevent deletion.
                    if (locations.length <= 1) {
                         console.error("Non puoi eliminare l'unica sede rimasta.");
                         return;
                    }
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/locations`, loc.id));
                });

                div.appendChild(input);
                div.appendChild(removeBtn);
                locationsList.appendChild(div);
            });

            const addLocationInput = document.createElement('input');
            addLocationInput.type = 'text';
            addLocationInput.placeholder = 'Nome nuova sede';
            addLocationInput.className = 'w-full p-2 border border-gray-300 rounded-lg mt-4';
            locationsList.appendChild(addLocationInput);
            
            document.getElementById('add-location-btn').onclick = () => {
                const name = addLocationInput.value.trim();
                if (name) {
                    addLocation(name);
                    addLocationInput.value = '';
                }
            };
        }

        function addEmployeeField() {
            const configContainer = document.getElementById('employees-config');
            const row = document.createElement('div');
            row.className = 'employee-entry flex items-center space-x-2 mb-2';
            row.innerHTML = `
                <input type="text" class="w-1/3 employee-input employee-name" placeholder="Nome">
                <input type="text" class="w-1/6 employee-input employee-id text-center" placeholder="ID">
                <input type="number" class="w-1/6 employee-input employee-hours" placeholder="Ore">
                <button class="w-1/6 bg-red-500 text-white p-2 rounded-lg remove-employee-btn">Rimuovi</button>
            `;
            configContainer.appendChild(row);
            row.querySelector('.remove-employee-btn').addEventListener('click', (e) => {
                e.target.closest('.employee-entry').remove();
            });
        }
        
        function addTimeSlotField() {
            const configContainer = document.getElementById('time-slots-config');
            const row = document.createElement('div');
            row.className = 'time-slot-entry flex items-center space-x-2 mb-2';
            const hourOptions = getHourOptions();
            
            const startSelect = document.createElement('select');
            startSelect.className = 'w-1/3 time-slot-input time-slot-start';
            hourOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                startSelect.appendChild(opt);
            });

            const endSelect = document.createElement('select');
            endSelect.className = 'w-1/3 time-slot-input time-slot-end';
            hourOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                endSelect.appendChild(opt);
            });

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = `&times;`;
            removeBtn.className = 'remove-time-slot-btn';

            row.appendChild(startSelect);
            row.appendChild(endSelect);
            row.appendChild(removeBtn);
            configContainer.appendChild(row);
            row.querySelector('.remove-time-slot-btn').addEventListener('click', (e) => {
                e.target.closest('.time-slot-entry').remove();
            });
        }

        function updateWeekDisplay() {
            const startOfWeek = getStartOfWeek(currentWeekStart);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            document.getElementById('week-dates').textContent = `${formatDateDisplay(startOfWeek)} - ${formatDateDisplay(endOfWeek)}`;
            document.getElementById('week-info').textContent = `Settimana ${getWeekNumber(startOfWeek)}`;
        }

        // --- UTILITY FUNCTIONS ---
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getStartOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Regola per iniziare il Lunedì
            return new Date(date.setDate(diff));
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function formatDateDisplay(date) {
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
        }
        
        // --- FUNZIONI DI ESPORTAZIONE ---
        async function fetchAndGenerateWeeksHtml(startDate, endDate) {
            let tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            document.body.appendChild(tempContainer);

            let currentDate = getStartOfWeek(startDate);
            const endOfWeekEndDate = getStartOfWeek(endDate);
            endOfWeekEndDate.setDate(endOfWeekEndDate.getDate() + 7);

            while (currentDate < endOfWeekEndDate) {
                const dateKey = formatDate(currentDate);
                const weekEndDate = new Date(currentDate);
                weekEndDate.setDate(weekEndDate.getDate() + 6);

                const scheduleDocRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/schedules`, dateKey);
                const scheduleDoc = await getDoc(scheduleDocRef);
                
                let scheduleData = {};
                if (scheduleDoc.exists()) {
                    try {
                        scheduleData = JSON.parse(scheduleDoc.data().schedule);
                    } catch (e) {
                        console.error(`Errore nell'analisi dell'orario per la settimana del ${dateKey}:`, e);
                    }
                }
                
                const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/locations/${currentLocationId}/configs`, dateKey);
                const configDoc = await getDoc(configDocRef);
                
                let weekScheduleHours = scheduleHours;
                if (configDoc.exists()) {
                    try {
                        weekScheduleHours = JSON.parse(configDoc.data().scheduleHours);
                    } catch (e) {
                        console.error(`Errore nell'analisi delle fasce orarie per la settimana del ${dateKey}:`, e);
                    }
                }

                // Genera l'HTML per la singola settimana
                let weekHtml = `
                    <div class="my-8">
                        <h2 class="text-xl font-bold text-gray-700 mb-4">Orario ${formatDateDisplay(currentDate)} - ${formatDateDisplay(weekEndDate)}</h2>
                        <table class="w-full text-sm text-left text-gray-500 rounded-lg overflow-hidden border border-gray-300">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Ora</th>
                                    <th scope="col" class="py-3 px-6">Lunedì</th>
                                    <th scope="col" class="py-3 px-6">Martedì</th>
                                    <th scope="col" class="py-3 px-6">Mercoledì</th>
                                    <th scope="col" class="py-3 px-6">Giovedì</th>
                                    <th scope="col" class="py-3 px-6">Venerdì</th>
                                    <th scope="col" class="py-3 px-6">Sabato</th>
                                    <th scope="col" class="py-3 px-6">Domenica</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                weekScheduleHours.forEach((hour) => {
                    weekHtml += `<tr class="bg-white border-b"><th class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap text-center">${hour.start} - ${hour.end}</th>`;
                    for (let day = 0; day < 7; day++) {
                        const scheduleKey = `${hour.start}-${hour.end}-${day}`;
                        const employees = scheduleData[scheduleKey] ? scheduleData[scheduleKey].filter(id => id.trim() !== '').join(', ') : '';
                        weekHtml += `<td class="py-4 px-6 text-center">${employees}</td>`;
                    }
                    weekHtml += `</tr>`;
                });
                weekHtml += `</tbody></table></div>`;
                tempContainer.innerHTML += weekHtml;

                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            return tempContainer;
        }

        // --- EVENT LISTENERS ---
        document.getElementById('next-week').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            loadConfigAndSchedule();
        });

        document.getElementById('prev-week').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            loadConfigAndSchedule();
        });

        document.getElementById('edit-employees-btn').addEventListener('click', () => {
            document.getElementById('employees-modal').classList.remove('hidden');
            renderEmployeeConfig();
        });
        document.getElementById('cancel-employees-btn').addEventListener('click', () => {
            document.getElementById('employees-modal').classList.add('hidden');
            document.getElementById('employee-error').textContent = '';
        });
        document.getElementById('save-employees-btn').addEventListener('click', saveEmployeesConfig);

        document.getElementById('edit-time-slots-btn').addEventListener('click', () => {
            document.getElementById('time-slots-modal').classList.remove('hidden');
            renderTimeSlotsConfig();
        });
        document.getElementById('cancel-time-slots-btn').addEventListener('click', () => document.getElementById('time-slots-modal').classList.add('hidden'));
        document.getElementById('save-time-slots-btn').addEventListener('click', saveTimeSlotsConfig);
        
        document.getElementById('manage-locations-btn').addEventListener('click', () => {
            document.getElementById('locations-modal').classList.remove('hidden');
            renderLocationsModal();
        });
        document.getElementById('close-locations-modal').addEventListener('click', () => document.getElementById('locations-modal').classList.add('hidden'));

        document.getElementById('location-select').addEventListener('change', (e) => {
            currentLocationId = e.target.value;
            loadConfigAndSchedule();
        });
        
        // Eventi per l'esportazione
        document.getElementById('printBtn').addEventListener('click', () => {
            window.print();
        });
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            document.getElementById('export-modal').classList.remove('hidden');
        });

        document.getElementById('cancelExportBtn').addEventListener('click', () => {
            document.getElementById('export-modal').classList.add('hidden');
        });

        document.getElementById('confirmExportBtn').addEventListener('click', async () => {
            const startDateStr = document.getElementById('startDateInput').value;
            const endDateStr = document.getElementById('endDateInput').value;

            if (!startDateStr || !endDateStr) {
                showMessage('Errore: Inserisci le date di inizio e fine.');
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');

            if (startDate > endDate) {
                showMessage('Errore: La data di inizio deve essere precedente o uguale alla data di fine.');
                return;
            }

            document.getElementById('export-modal').classList.add('hidden');
            
            const tempContainer = await fetchAndGenerateWeeksHtml(startDate, endDate);
            
            try {
                const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const canvas = await html2canvas(tempContainer, { scale: 2, logging: false });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(`orario_dal_${formatDate(startDate)}_al_${formatDate(endDate)}.pdf`);
                showMessage('PDF generato con successo!');
            } catch (error) {
                console.error('Errore durante la generazione del PDF:', error);
                showMessage('Errore durante la generazione del PDF. Controlla la console per i dettagli.');
            } finally {
                document.body.removeChild(tempContainer);
            }
        });

        // Inizializza l'app all'avvio
        window.onload = () => {
            const now = new Date();
            const startOfWeek = getStartOfWeek(now);
            currentWeekStart = startOfWeek;
            signIn();
        };
    </script>
</body>
</html>